<script>
const budgetApp = {
    // --- Application State ---
    state: {
        transactions: [],
        currentDate: new Date(),
        activeFilter: 'all',
        editingTxId: null, // ID of transaction being edited
        charts: { category: null },
    },

    // --- Static Configuration (USER REQUEST APPLIED) ---
    config: {
        localStorageKey: 'budgetAppTransactions_v4', // Changed version for the update
        categories: {
            expense: [
                { id: 'food', text: '음식', icon: 'restaurant-2' },
                { id: 'fashion', text: '패션/쇼핑', icon: 't-shirt' },
                { id: 'date', text: '데이트/유흥', icon: 'heart-3' },
                { id: 'transport', text: '교통', icon: 'bus' },
                { id: 'housing', text: '주거/통신', icon: 'home-gear' },
                { id: 'leisure', text: '문화/여가', icon: 'gamepad' },
                { id: 'health', text: '건강/미용', icon: 'heart-pulse' },
                { id: 'points_expense', text: '포인트 사용', icon: 'star-half' }, // '포인트 사용' 추가
                { id: 'other', text: '기타 지출', icon: 'price-tag-3' }
            ],
            income: [
                { id: 'salary', text: '월급', icon: 'briefcase-4' },
                { id: 'investment', text: '투자/금융소득', icon: 'line-chart' },
                { id: 'allowance', text: '용돈', icon: 'gift' },
                { id: 'points_income', text: '포인트 적립', icon: 'star' }, // '포인트 적립' 추가
                { id: 'other_income', text: '기타 수입', icon: 'creative-commons-nd' }
            ]
        },
        filters: [
            { id: 'all', text: '전체' }, { id: 'expense', text: '지출' }, { id: 'income', text: '수입' },
            { id: 'food', text: '음식' }, { id: 'fashion', text: '패션' }, { id: 'date', text: '데이트' }
        ]
    },
    
    // --- DOM Element Cache ---
    dom: {},

    // --- App Initialization ---
    init() {
        this.cacheDom();
        this.events.init();
        this.api.loadTransactions();
        this.ui.initCharts();
        this.ui.populateFilters();
        this.ui.showSection('dashboard');
        console.log("Budget App Initialized (Points Category Added)");
    },
    
    cacheDom() {
        this.dom = {
            sections: {
                dashboard: document.getElementById('dashboard-section'),
                transactions: document.getElementById('transactions-section'),
                add: document.getElementById('add-section'),
            },
            nav: document.querySelector('nav'),
            dashboardDisplay: document.getElementById('dashboard-month-display'),
            totalBalance: document.getElementById('total-balance'),
            totalIncome: document.getElementById('total-income'),
            totalExpense: document.getElementById('total-expense'),
            recentTransactions: document.getElementById('recent-transactions-container'),
            categoryChart: document.getElementById('category-chart'),
            filterContainer: document.getElementById('transactions-filter-container'),
            listContainer: document.getElementById('transactions-list-container'),
            form: document.getElementById('transaction-form'),
            formTitle: document.getElementById('form-title'),
            saveBtn: document.getElementById('save-btn'),
            deleteBtn: document.getElementById('delete-btn'),
            typeButtons: document.querySelectorAll('.transaction-type-btn'),
            amountInput: document.getElementById('amount'),
            textInput: document.getElementById('text'),
            categorySelect: document.getElementById('category'),
            dateInput: document.getElementById('date'),
        };
    },

    // --- Core Logic ---
    core: {
        addTransaction(newTx) {
            budgetApp.state.transactions.unshift(newTx);
            this.sortTransactions();
            budgetApp.api.saveTransactions();
        },
        updateTransaction(updatedTx) {
            const index = budgetApp.state.transactions.findIndex(t => t.id === updatedTx.id);
            if (index !== -1) {
                budgetApp.state.transactions[index] = updatedTx;
                this.sortTransactions();
                budgetApp.api.saveTransactions();
            }
        },
        deleteTransaction(txId) {
            budgetApp.state.transactions = budgetApp.state.transactions.filter(t => t.id !== txId);
            budgetApp.api.saveTransactions();
        },
        sortTransactions() {
            budgetApp.state.transactions.sort((a,b) => new Date(b.date) - new Date(a.date));
        },
        getTransactionsForMonth(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            return budgetApp.state.transactions.filter(t => {
                const txDate = new Date(t.date);
                return txDate.getFullYear() === year && txDate.getMonth() === month;
            });
        },
    },

    // --- Data Persistence ---
    api: {
        loadTransactions() {
            const stored = localStorage.getItem(budgetApp.config.localStorageKey);
            if (stored) {
                budgetApp.state.transactions = JSON.parse(stored);
            } else {
                const today = new Date();
                budgetApp.state.transactions = [
                    { id: `tx${Date.now()+1}`, type: 'expense', amount: 12000, date: today.toISOString().slice(0,10), category: 'food', text: '점심 (파스타)' },
                    { id: `tx${Date.now()+2}`, type: 'expense', amount: 55000, date: new Date(new Date().setDate(today.getDate() - 1)).toISOString().slice(0,10), category: 'fashion', text: 'H&M 티셔츠' },
                    { id: `tx${Date.now()+3}`, type: 'income', amount: 3000000, date: new Date(new Date().setDate(today.getDate() - 2)).toISOString().slice(0,10), category: 'salary', text: `${today.getMonth()+1}월 급여` }
                ];
                budgetApp.core.sortTransactions();
                this.saveTransactions();
            }
        },
        saveTransactions() {
            localStorage.setItem(budgetApp.config.localStorageKey, JSON.stringify(budgetApp.state.transactions));
        },
    },

    // --- UI Rendering ---
    ui: {
        showSection(sectionId) {
            Object.values(budgetApp.dom.sections).forEach(s => s.classList.add('hidden'));
            budgetApp.dom.sections[sectionId].classList.remove('hidden');
            const activeTab = budgetApp.dom.nav.querySelector(`[data-tab="${sectionId}"]`);
            if (activeTab) {
                budgetApp.dom.nav.querySelectorAll('[data-tab]').forEach(t => t.classList.replace('text-primary', 'text-gray-500'));
                activeTab.classList.replace('text-gray-500', 'text-primary');
            }
            if (this.render[sectionId]) this.render[sectionId]();
        },
        render: {
            dashboard() {
                const { currentDate, transactions } = budgetApp.state;
                const monthlyTxs = budgetApp.core.getTransactionsForMonth(currentDate);
                let monthIncome = 0, monthExpense = 0;
                monthlyTxs.forEach(t => t.type === 'income' ? monthIncome += t.amount : monthExpense += t.amount);
                
                budgetApp.dom.dashboardDisplay.textContent = `${currentDate.getFullYear()}년 ${currentDate.getMonth() + 1}월`;
                budgetApp.dom.totalBalance.textContent = `₩${(monthIncome - monthExpense).toLocaleString()}`;
                budgetApp.dom.totalIncome.textContent = `+₩${monthIncome.toLocaleString()}`;
                budgetApp.dom.totalExpense.textContent = `-₩${monthExpense.toLocaleString()}`;

                const recentTxs = transactions.slice(0, 5);
                budgetApp.dom.recentTransactions.innerHTML = recentTxs.length > 0 
                    ? `<div class="divide-y divide-gray-100">${recentTxs.map(t => budgetApp.ui.templates.transactionItem(t)).join('')}</div>`
                    : `<div class="text-center p-8 text-gray-500">거래 내역이 없습니다.</div>`;

                const expenseByCategory = {};
                monthlyTxs.filter(t => t.type === 'expense').forEach(t => {
                    const category = budgetApp.config.categories.expense.find(c => c.id === t.category);
                    if (category) {
                        expenseByCategory[category.text] = (expenseByCategory[category.text] || 0) + t.amount;
                    }
                });
                const chartData = Object.entries(expenseByCategory).map(([name, value]) => ({ name, value }));
                budgetApp.state.charts.category.setOption({ series: [{ data: chartData }] });
            },
            transactions() {
                const { transactions, activeFilter } = budgetApp.state;
                const filteredTxs = transactions.filter(t => {
                    if (activeFilter === 'all') return true;
                    if (activeFilter === 'income' || activeFilter === 'expense') return t.type === activeFilter;
                    return t.category === activeFilter;
                });
                
                if (filteredTxs.length === 0) {
                    budgetApp.dom.listContainer.innerHTML = `<div class="text-center py-16 text-gray-500">해당 내역이 없습니다.</div>`;
                } else {
                    const grouped = filteredTxs.reduce((acc, tx) => {
                        (acc[tx.date] = acc[tx.date] || []).push(tx);
                        return acc;
                    }, {});
                    let html = '';
                    for (const date in grouped) {
                        html += `
                            <div class="mb-4">
                                <h3 class="font-semibold text-gray-600 px-1 mb-2">${new Date(date+'T00:00:00').toLocaleDateString('ko-KR', { month: 'long', day: 'numeric', weekday: 'long' })}</h3>
                                <div class="bg-white rounded-xl shadow-sm divide-y divide-gray-100">
                                    ${grouped[date].map(tx => budgetApp.ui.templates.transactionItem(tx)).join('')}
                                </div>
                            </div>`;
                    }
                    budgetApp.dom.listContainer.innerHTML = html;
                }
            },
            add() {
                budgetApp.state.editingTxId = null;
                budgetApp.dom.formTitle.textContent = '새 거래 추가';
                budgetApp.dom.saveBtn.textContent = '거래 저장';
                budgetApp.dom.deleteBtn.classList.add('hidden');
                budgetApp.dom.form.reset();
                budgetApp.dom.dateInput.value = new Date().toISOString().slice(0, 10);
                budgetApp.events.setActiveTypeButton('expense');
                budgetApp.ui.updateCategoryOptions('expense');
            },
            edit(tx) {
                budgetApp.state.editingTxId = tx.id;
                budgetApp.dom.formTitle.textContent = '거래 내역 수정';
                budgetApp.dom.saveBtn.textContent = '변경 내용 저장';
                budgetApp.dom.deleteBtn.classList.remove('hidden');

                budgetApp.events.setActiveTypeButton(tx.type);
                budgetApp.ui.updateCategoryOptions(tx.type);
                budgetApp.dom.amountInput.value = tx.amount;
                budgetApp.dom.textInput.value = tx.text;
                budgetApp.dom.categorySelect.value = tx.category;
                budgetApp.dom.dateInput.value = tx.date;
                this.showSection('add');
            }
        },
        populateFilters() {
            this.dom.filterContainer.innerHTML = budgetApp.config.filters.map((f, i) =>
                `<button data-filter="${f.id}" class="filter-btn whitespace-nowrap px-4 py-2 text-sm font-medium rounded-full ${i === 0 ? 'bg-primary text-white' : 'bg-gray-200 text-gray-700'}">${f.text}</button>`
            ).join('');
        },
        updateCategoryOptions(type) {
            this.dom.categorySelect.innerHTML = budgetApp.config.categories[type]
                .map(c => `<option value="${c.id}">${c.text}</option>`).join('');
        },
        initCharts() {
            this.charts = { category: echarts.init(this.dom.categoryChart) };
            this.charts.category.setOption({
                tooltip: { trigger: 'item', formatter: p => `${p.name}:<br/><b>₩${p.value.toLocaleString()}</b> (${p.percent}%)` },
                series: [{ type: 'pie', radius: ['50%', '80%'], avoidLabelOverlap: true, itemStyle: { borderRadius: 5, borderColor: '#fff', borderWidth: 2 }, label: { show: false }, data: [] }]
            });
            budgetApp.state.charts = this.charts;
        },
        templates: {
            transactionItem(t) {
                const allCategories = [...budgetApp.config.categories.expense, ...budgetApp.config.categories.income];
                const category = allCategories.find(c => c.id === t.category) || {};
                const color = t.type === 'income' ? 'text-green-600' : 'text-red-600';
                return `
                    <div class="transaction-item flex items-center p-4 cursor-pointer" data-id="${t.id}">
                        <div class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-xl mr-4"><i class="ri-${category.icon}-line ri-lg text-gray-700"></i></div>
                        <div class="flex-1"><p class="font-medium leading-tight">${t.text}</p><p class="text-sm text-gray-500">${new Date(t.date+'T00:00:00').toLocaleDateString('ko-KR', {month:'long', day:'numeric'})}</p></div>
                        <p class="font-bold text-lg ${color}">${t.type === 'income' ? '+' : '-'}₩${t.amount.toLocaleString()}</p>
                    </div>`;
            }
        }
    },
    
    // --- Event Handling ---
    events: {
        init() {
            budgetApp.dom.nav.addEventListener('click', e => {
                const tab = e.target.closest('button[data-tab]');
                if (tab && !tab.disabled) budgetApp.ui.showSection(tab.dataset.tab);
            });
            document.getElementById('dashboard-prev-month').addEventListener('click', () => this.changeMonth(-1));
            document.getElementById('dashboard-next-month').addEventListener('click', () => this.changeMonth(1));
            document.getElementById('see-all-btn').addEventListener('click', () => budgetApp.ui.showSection('transactions'));
            budgetApp.dom.form.addEventListener('submit', this.handleFormSubmit);
            budgetApp.dom.deleteBtn.addEventListener('click', this.handleDeleteClick);
            budgetApp.dom.typeButtons.forEach(btn => btn.addEventListener('click', this.handleTypeChange));
            budgetApp.dom.filterContainer.addEventListener('click', this.handleFilterClick);
            budgetApp.dom.recentTransactions.addEventListener('click', this.handleTransactionClick);
            budgetApp.dom.listContainer.addEventListener('click', this.handleTransactionClick);
        },
        changeMonth(direction) {
            budgetApp.state.currentDate.setMonth(budgetApp.state.currentDate.getMonth() + direction, 1);
            budgetApp.ui.render.dashboard();
        },
        handleFormSubmit(e) {
            e.preventDefault();
            const form = budgetApp.dom;
            const amount = parseInt(form.amountInput.value);
            if (!amount || amount <= 0 || !form.textInput.value) { alert("금액과 내용을 올바르게 입력해주세요."); return; }
            
            const type = document.querySelector('.transaction-type-btn.bg-primary').dataset.type;
            const txData = { type, amount, date: form.dateInput.value, category: form.categorySelect.value, text: form.textInput.value };

            if (budgetApp.state.editingTxId) {
                txData.id = budgetApp.state.editingTxId;
                budgetApp.core.updateTransaction(txData);
                alert("수정되었습니다.");
            } else {
                txData.id = `tx${Date.now()}`;
                budgetApp.core.addTransaction(txData);
                alert("저장되었습니다.");
            }
            budgetApp.ui.showSection('dashboard');
        },
        handleDeleteClick() {
            if (budgetApp.state.editingTxId && confirm("정말로 이 내역을 삭제하시겠습니까?")) {
                budgetApp.core.deleteTransaction(budgetApp.state.editingTxId);
                alert("삭제되었습니다.");
                budgetApp.ui.showSection('dashboard');
            }
        },
        handleTransactionClick(e) {
            const item = e.target.closest('.transaction-item');
            if (!item) return;
            const txId = item.dataset.id;
            const tx = budgetApp.state.transactions.find(t => t.id === txId);
            if (tx) {
                budgetApp.ui.render.edit(tx);
            }
        },
        handleTypeChange(e) {
            const selectedType = e.target.dataset.type;
            this.setActiveTypeButton(selectedType);
            budgetApp.ui.updateCategoryOptions(selectedType);
        },
        setActiveTypeButton(type) {
             budgetApp.dom.typeButtons.forEach(btn => {
                btn.classList.toggle('bg-primary', btn.dataset.type === type);
                btn.classList.toggle('text-white', btn.dataset.type === type);
                btn.classList.toggle('text-gray-600', btn.dataset.type !== type);
            });
        },
        handleFilterClick(e) {
            const btn = e.target.closest('button.filter-btn');
            if(!btn) return;
            budgetApp.dom.filterContainer.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.replace('bg-primary', 'bg-gray-200');
                b.classList.replace('text-white','text-gray-700');
            });
            btn.classList.replace('bg-gray-200','bg-primary');
            btn.classList.replace('text-gray-700','text-white');
            budgetApp.state.activeFilter = btn.dataset.filter;
            budgetApp.ui.render.transactions();
        }
    }
};

document.addEventListener('DOMContentLoaded', () => budgetApp.init());
</script>
