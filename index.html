<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Household Ledger (Optimized)</title>
<script src="https://cdn.tailwindcss.com/3.4.16"></script>
<script>tailwind.config={theme:{extend:{colors:{primary:'#4F46E5',secondary:'#10B981'},borderRadius:{'none':'0px','sm':'4px',DEFAULT:'8px','md':'12px','lg':'16px','xl':'20px','2xl':'24px','3xl':'32px','full':'9999px','button':'8px'}}}}</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
<style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #F9FAFB;
    }
    .hide-arrows::-webkit-outer-spin-button,
    .hide-arrows::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    .hide-arrows {
        -moz-appearance: textfield;
    }
</style>
</head>
<body class="bg-gray-50">
<div class="fixed top-0 w-full bg-white shadow-sm z-50">
    <div class="flex items-center justify-between px-4 py-3">
        <div class="flex items-center">
            <h1 class="text-lg font-['Pacifico'] text-primary">logo</h1>
        </div>
        <div class="flex items-center space-x-2">
            <div class="w-8 h-8 flex items-center justify-center"><i class="ri-search-line ri-lg text-gray-600"></i></div>
            <div class="w-8 h-8 flex items-center justify-center"><i class="ri-notification-3-line ri-lg text-gray-600"></i></div>
            <div class="w-8 h-8 flex items-center justify-center"><i class="ri-menu-line ri-lg text-gray-600"></i></div>
        </div>
    </div>
</div>

<div class="pt-14 pb-16 min-h-screen">
    <div id="dashboard" class="px-4 py-4">
        <div class="flex items-center justify-between mb-4">
            <button class="w-8 h-8 flex items-center justify-center text-gray-500"><i class="ri-arrow-left-s-line ri-lg"></i></button>
            <h2 class="text-lg font-medium" id="current-month-display"></h2>
            <button class="w-8 h-8 flex items-center justify-center text-gray-500"><i class="ri-arrow-right-s-line ri-lg"></i></button>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
            <div class="flex items-center justify-between mb-3">
                <p class="text-sm text-gray-500">이번 달 잔액</p>
                <a href="#" class="text-xs text-primary">상세보기 ></a>
            </div>
            <h1 class="text-2xl font-bold" id="total-balance">0원</h1>
            <div class="flex justify-between mt-4">
                <div>
                    <p class="text-xs text-gray-500">수입</p>
                    <p class="text-sm font-medium text-green-600" id="total-income">+0원</p>
                </div>
                <div>
                    <p class="text-xs text-gray-500">지출</p>
                    <p class="text-sm font-medium text-red-600" id="total-expense">-0원</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-medium">Daily Spending</h3>
                <select class="text-xs text-gray-500 bg-transparent border-none">
                    <option>Last 7 days</option>
                </select>
            </div>
            <div id="spending-chart" class="w-full h-48"></div>
        </div>
        <h3 class="font-medium mb-3">Top Categories</h3>
        <div id="top-categories-container" class="grid grid-cols-2 gap-3 mb-4"></div>
        <div class="flex justify-between items-center mb-3">
            <h3 class="font-medium">Recent Transactions</h3>
            <a href="#" class="text-primary text-sm">See All</a>
        </div>
        <div id="recent-transactions-container" class="bg-white rounded-lg shadow-sm divide-y"></div>
    </div>

    <div id="add-transaction" class="hidden px-4 py-4">
        <h2 class="text-xl font-semibold mb-4">Add Transaction</h2>
        <form id="transaction-form">
            <div class="mb-4">
                <p class="text-sm text-gray-500 mb-2">Transaction Type</p>
                <div class="flex bg-gray-100 rounded-full p-1">
                    <button type="button" id="expense-btn" class="flex-1 py-2 rounded-full bg-primary text-white text-sm font-medium !rounded-button">Expense</button>
                    <button type="button" id="income-btn" class="flex-1 py-2 rounded-full text-gray-600 text-sm font-medium !rounded-button">Income</button>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm text-gray-500 mb-2" for="amount">Amount</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"><span class="text-gray-500">₩</span></div>
                    <input type="number" id="amount" class="hide-arrows w-full pl-8 pr-3 py-3 bg-gray-100 rounded border-none focus:ring-2 focus:ring-primary" placeholder="0">
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm text-gray-500 mb-2" for="date">Date</label>
                <input type="date" id="date" class="w-full px-3 py-3 bg-gray-100 rounded border-none focus:ring-2 focus:ring-primary">
            </div>
            <div class="mb-4">
                <label class="block text-sm text-gray-500 mb-2" for="category">Category</label>
                <div class="relative">
                    <select id="category" class="w-full px-3 py-3 bg-gray-100 rounded border-none focus:ring-2 focus:ring-primary appearance-none"></select>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"><i class="ri-arrow-down-s-line text-gray-500"></i></div>
                </div>
            </div>
            <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg font-medium !rounded-button">Save Transaction</button>
        </form>
    </div>

    <div id="transactions" class="hidden px-4 py-4">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">Transactions</h2>
            <div class="flex space-x-2">
                <button class="w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full"><i class="ri-search-line text-gray-600"></i></button>
                <button class="w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full"><i class="ri-filter-3-line text-gray-600"></i></button>
            </div>
        </div>
        <div id="transactions-filter-container" class="flex space-x-2 mb-4 overflow-x-auto py-1"></div>
        <div id="transactions-list-container"></div>
    </div>

    <div id="analysis" class="hidden px-4 py-4">
        <h2 class="text-xl font-semibold mb-4">Analysis</h2>
        <div class="flex bg-gray-100 rounded-full p-1 mb-4">
            <button class="flex-1 py-2 rounded-full bg-primary text-white text-sm font-medium !rounded-button">Month</button>
            <button class="flex-1 py-2 rounded-full text-gray-600 text-sm font-medium !rounded-button">Quarter</button>
            <button class="flex-1 py-2 rounded-full text-gray-600 text-sm font-medium !rounded-button">Year</button>
        </div>
        <div class="flex items-center justify-between mb-4">
            <button class="w-8 h-8 flex items-center justify-center text-gray-500"><i class="ri-arrow-left-s-line ri-lg"></i></button>
            <h3 class="text-lg font-medium" id="analysis-month-display">June 2025</h3>
            <button class="w-8 h-8 flex items-center justify-center text-gray-500"><i class="ri-arrow-right-s-line ri-lg"></i></button>
        </div>
        <div class="flex justify-center space-x-4 mb-4">
            <button id="expense-toggle" class="px-4 py-2 bg-primary text-white rounded-full text-sm font-medium !rounded-button">Expenses</button>
            <button id="income-toggle" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-full text-sm font-medium !rounded-button">Income</button>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
            <div id="category-chart" class="w-full h-64"></div>
        </div>
        <h3 class="font-medium mb-3">Category Breakdown</h3>
        <div id="category-breakdown-container" class="bg-white rounded-lg shadow-sm divide-y"></div>
    </div>
</div>

<div class="fixed bottom-20 right-4 z-40">
    <button id="add-transaction-btn" class="w-14 h-14 bg-primary rounded-full shadow-lg flex items-center justify-center">
        <i class="ri-add-line ri-xl text-white"></i>
    </button>
</div>
<div class="fixed bottom-16 w-full bg-white border-t border-gray-100 z-40">
    <div class="px-4 py-1.5 text-center">
        <p class="text-xs text-gray-500" id="exchange-rate-display">Exchange Rate: ₩1,300 = $1.00 USD</p>
    </div>
</div>
<div class="fixed bottom-0 w-full bg-white shadow-lg border-t border-gray-200 z-50">
    <div class="grid grid-cols-5 h-14">
        <button data-tab="dashboard" class="flex flex-col items-center justify-center space-y-0.5 text-primary"><i class="ri-home-4-line"></i><span class="text-[10px]">홈</span></button>
        <button data-tab="transactions" class="flex flex-col items-center justify-center space-y-0.5 text-gray-500"><i class="ri-list-check"></i><span class="text-[10px]">내역</span></button>
        <button data-tab="add-transaction" class="flex flex-col items-center justify-center space-y-0.5 text-gray-500"><i class="ri-add-circle-line"></i><span class="text-[10px]">쓰기</span></button>
        <button data-tab="analysis" class="flex flex-col items-center justify-center space-y-0.5 text-gray-500"><i class="ri-pie-chart-line"></i><span class="text-[10px]">통계</span></button>
        <a href="#" data-tab="profile" class="flex flex-col items-center justify-center space-y-0.5 text-gray-500"><i class="ri-user-3-line"></i><span class="text-[10px]">MY</span></a>
    </div>
</div>

<script>
/**
 * =================================================================
 * Household Ledger Application (Optimized Version)
 * =================================================================
 * This script is organized into a single `ledgerApp` object to avoid
 * polluting the global namespace and to structure the code by its
 * responsibility (state, utils, api, ui, core, events, init).
 *
 * Key Improvements:
 * - Separation of Concerns: Data logic is separated from UI rendering.
 * - Performance: DOM updates are batched to avoid re-rendering in loops.
 * - Maintainability: Reusable templates and a central config make
 * updates easier and reduce code duplication.
 */
const ledgerApp = {
    // Application state and configuration
    state: {
        transactions: [],
        currentDate: new Date(),
        exchangeRate: 1300,
        summary: {},
        charts: {
            spending: null,
            category: null
        },
        dom: {}, // To cache DOM element queries
    },

    config: {
        localStorageKey: 'gagyebuTransactions',
        categories: {
            food: { text: 'Food & Dining', icon: 'restaurant', color: 'blue' },
            shopping: { text: 'Shopping', icon: 'shopping-bag', color: 'purple' },
            transport: { text: 'Transport', icon: 'taxi', color: 'yellow' },
            entertainment: { text: 'Entertainment', icon: 'movie-2', color: 'indigo' },
            utilities: { text: 'Utilities', icon: 'lightbulb', color: 'orange' },
            housing: { text: 'Housing', icon: 'home-4', color: 'red' },
            health: { text: 'Health', icon: 'health-book', color: 'pink' },
            salary: { text: 'Salary', icon: 'briefcase-4', color: 'green' },
            investment: { text: 'Investment', icon: 'stock', color: 'teal' },
            date: { text: '데이트 통장', icon: 'calendar-event', color: 'pink' },
            other: { text: 'Other', icon: 'question', color: 'gray' }
        },
        filters: {
            all: 'All',
            income: 'Income',
            expense: 'Expense',
            food: 'Food',
            transport: 'Transport',
            shopping: 'Shopping'
        },
        defaultIcon: { icon: 'money', color: 'gray' }
    },

    // Utility functions
    utils: {
        /**
         * Formats a date string (YYYY-MM-DD) for display.
         * @param {string} dateString - The date string to format.
         * @returns {string} Formatted date string (e.g., "Today, June 22").
         */
        formatDateForDisplay(dateString) {
            const dateObj = new Date(dateString + 'T00:00:00');
            const today = new Date();
            const yesterday = new Date();
            yesterday.setDate(today.getDate() - 1);

            if (dateObj.toDateString() === today.toDateString()) {
                return `Today, ${dateObj.toLocaleString('en-US', { month: 'long', day: 'numeric' })}`;
            }
            if (dateObj.toDateString() === yesterday.toDateString()) {
                return `Yesterday, ${dateObj.toLocaleString('en-US', { month: 'long', day: 'numeric' })}`;
            }
            return `${dateObj.toLocaleString('en-US', { month: 'long', day: 'numeric' })}, ${dateObj.getFullYear()}`;
        },
        /**
         * Formats a number as Korean Won.
         * @param {number} amount - The amount to format.
         * @param {string} type - 'income' or 'expense'.
         * @returns {string} Formatted currency string (e.g., "+₩1,000").
         */
        formatKRW(amount, type) {
            const prefix = type === 'income' ? '+' : '-';
            return `${prefix}₩${amount.toLocaleString()}`;
        },
        /**
         * Generates a simple unique ID for a transaction.
         * @returns {string} A new transaction ID.
         */
        generateId() {
            return `tx-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
        }
    },

    // API interactions (LocalStorage, Fetch)
    api: {
        loadTransactions() {
            const stored = localStorage.getItem(ledgerApp.config.localStorageKey);
            if (stored) {
                ledgerApp.state.transactions = JSON.parse(stored);
            } else {
                // Initial dummy data
                ledgerApp.state.transactions = [
                    { id: 't1', type: 'expense', amount: 7475, date: '2025-06-22', category: 'food', memo: '', time: '10:23 AM' },
                    { id: 't2', type: 'expense', amount: 12500, date: '2025-06-22', category: 'food', memo: '', time: '1:15 PM' },
                    { id: 't3', type: 'expense', amount: 8500, date: '2025-06-22', category: 'transport', memo: '', time: '3:45 PM' },
                    { id: 't7', type: 'income', amount: 2640000, date: '2025-06-20', category: 'salary', memo: '', time: '9:00 AM' }
                ];
                ledgerApp.api.saveTransactions();
            }
            // Sort by date descending
            ledgerApp.state.transactions.sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time));
        },
        saveTransactions() {
            localStorage.setItem(ledgerApp.config.localStorageKey, JSON.stringify(ledgerApp.state.transactions));
        },
        async fetchExchangeRate() {
            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await response.json();
                ledgerApp.state.exchangeRate = data.rates.KRW;
                ledgerApp.state.dom.exchangeRateDisplay.textContent = `Exchange Rate: ₩${ledgerApp.state.exchangeRate.toLocaleString()} = $1.00 USD`;
            } catch (error) {
                console.error('Failed to fetch exchange rate:', error);
                ledgerApp.state.dom.exchangeRateDisplay.textContent = `Exchange Rate: ₩1,300 = $1.00 USD (Error)`;
            }
        }
    },

    // Core data processing functions
    core: {
        /**
         * Calculates all necessary summaries from the transactions data.
         */
        calculateSummary() {
            const today = ledgerApp.state.currentDate;
            const currentMonthStr = today.toISOString().slice(0, 7);
            
            const summary = {
                monthIncome: 0,
                monthExpense: 0,
                monthBalance: 0,
                categorySpending: {},
                categoryIncome: {},
                last7DaysExpenses: {},
                recentTransactions: ledgerApp.state.transactions.slice(0, 4)
            };

            // Calculate totals for the current month
            ledgerApp.state.transactions.forEach(t => {
                if (t.date.startsWith(currentMonthStr)) {
                    if (t.type === 'income') {
                        summary.monthIncome += t.amount;
                        summary.categoryIncome[t.category] = (summary.categoryIncome[t.category] || 0) + t.amount;
                    } else {
                        summary.monthExpense += t.amount;
                        summary.categorySpending[t.category] = (summary.categorySpending[t.category] || 0) + t.amount;
                    }
                }
            });
            summary.monthBalance = summary.monthIncome - summary.monthExpense;
            
            // Prepare data for the daily spending chart (last 7 days)
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 6); // Include today
            sevenDaysAgo.setHours(0, 0, 0, 0);

            ledgerApp.state.transactions.forEach(t => {
                 const transactionDate = new Date(t.date + 'T00:00:00');
                 if (t.type === 'expense' && transactionDate >= sevenDaysAgo && transactionDate <= today) {
                    summary.last7DaysExpenses[t.date] = (summary.last7DaysExpenses[t.date] || 0) + t.amount;
                 }
            });
            
            ledgerApp.state.summary = summary;
        },
    },

    // UI rendering functions
    ui: {
        // HTML template generators to keep rendering logic clean
        templates: {
            transactionItem(t) {
                const categoryInfo = ledgerApp.config.categories[t.category] || ledgerApp.config.defaultIcon;
                const amountClass = t.type === 'expense' ? 'text-red-600' : 'text-green-600';
                return `
                    <div class="p-3 flex items-center">
                        <div class="w-10 h-10 rounded-full bg-${categoryInfo.color}-100 flex items-center justify-center mr-3">
                            <i class="ri-${categoryInfo.icon}-line text-${categoryInfo.color}-600"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-sm font-medium">${categoryInfo.text}</h4>
                            <p class="text-xs text-gray-500">${t.time} • ${t.memo || 'Bank Transfer'}</p>
                        </div>
                        <p class="${amountClass} font-medium">${ledgerApp.utils.formatKRW(t.amount, t.type)}</p>
                    </div>`;
            },
            topCategoryItem(category, amount, totalExpense) {
                const categoryInfo = ledgerApp.config.categories[category] || ledgerApp.config.defaultIcon;
                const percentage = totalExpense > 0 ? (amount / totalExpense * 100).toFixed(1) : 0;
                return `
                    <div class="bg-white rounded-lg shadow-sm p-3">
                        <div class="flex items-center mb-2">
                            <div class="w-8 h-8 rounded-full bg-${categoryInfo.color}-100 flex items-center justify-center mr-2">
                                <i class="ri-${categoryInfo.icon}-line text-${categoryInfo.color}-600"></i>
                            </div>
                            <span class="font-medium text-sm">${categoryInfo.text}</span>
                        </div>
                        <p class="text-red-600 font-medium">${ledgerApp.utils.formatKRW(amount, 'expense')}</p>
                        <div class="w-full bg-gray-100 rounded-full h-1.5 mt-2">
                            <div class="bg-${categoryInfo.color}-600 h-1.5 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>`;
            },
             categoryBreakdownItem(item, totalAmount) {
                const categoryInfo = ledgerApp.config.categories[item.category] || ledgerApp.config.defaultIcon;
                const percentage = totalAmount > 0 ? (item.amount / totalAmount * 100) : 0;
                return `
                    <div class="p-3">
                        <div class="flex justify-between items-center mb-1">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-${categoryInfo.color}-100 flex items-center justify-center mr-2">
                                    <i class="ri-${categoryInfo.icon}-line text-${categoryInfo.color}-600"></i>
                                </div>
                                <span class="font-medium text-sm">${categoryInfo.text}</span>
                            </div>
                            <p class="text-sm font-medium">${ledgerApp.utils.formatKRW(item.amount, 'expense')}</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="w-full bg-gray-100 rounded-full h-1.5">
                                <div class="bg-${categoryInfo.color}-600 h-1.5 rounded-full" style="width: ${percentage.toFixed(1)}%"></div>
                            </div>
                            <span class="text-xs text-gray-500 ml-2">${percentage.toFixed(1)}%</span>
                        </div>
                    </div>`;
            }
        },

        // Main render functions for each section
        renderDashboard() {
            const { dom, state } = ledgerApp;
            const { summary } = state;
            
            // Update summary cards
            dom.totalBalance.textContent = `₩${summary.monthBalance.toLocaleString()}`;
            dom.totalIncome.textContent = `+₩${summary.monthIncome.toLocaleString()}`;
            dom.totalExpense.textContent = `-₩${summary.monthExpense.toLocaleString()}`;

            // Update recent transactions
            const recentHtml = summary.recentTransactions.map(ledgerApp.ui.templates.transactionItem).join('');
            dom.recentTransactionsContainer.innerHTML = recentHtml;

            // Update top categories
            const sortedCategories = Object.entries(summary.categorySpending).sort(([, a], [, b]) => b - a);
            const topCategoriesHtml = sortedCategories.slice(0, 4)
                .map(([cat, amount]) => ledgerApp.ui.templates.topCategoryItem(cat, amount, summary.monthExpense))
                .join('');
            dom.topCategoriesContainer.innerHTML = topCategoriesHtml;
            
            // Update spending chart
            const chartLabels = [];
            const chartValues = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date(state.currentDate);
                d.setDate(state.currentDate.getDate() - i);
                chartLabels.push(d.toLocaleString('en-US', { weekday: 'short' }));
                const dateKey = d.toISOString().slice(0, 10);
                chartValues.push(summary.last7DaysExpenses[dateKey] || 0);
            }

            state.charts.spending.setOption({
                xAxis: { data: chartLabels },
                series: [{ data: chartValues }]
            });
        },
        renderTransactions(filter = 'all') {
            const { dom, state, config } = ledgerApp;
            
            const filtered = state.transactions.filter(t => {
                if (filter === 'all') return true;
                if (filter === 'income' || filter === 'expense') return t.type === filter;
                return t.category === filter;
            });
            
            const groupedByDate = filtered.reduce((acc, t) => {
                (acc[t.date] = acc[t.date] || []).push(t);
                return acc;
            }, {});
            
            let listHtml = '';
            const sortedDates = Object.keys(groupedByDate).sort((a,b) => new Date(b) - new Date(a));

            for(const date of sortedDates) {
                const dailyTotal = groupedByDate[date].reduce((sum, t) => sum + (t.type === 'income' ? t.amount : -t.amount), 0);
                const totalColor = dailyTotal >= 0 ? 'text-green-600' : 'text-red-600';
                
                listHtml += `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-sm font-medium">${ledgerApp.utils.formatDateForDisplay(date)}</h3>
                            <p class="text-xs ${totalColor}">${dailyTotal >= 0 ? '+' : ''}₩${Math.abs(dailyTotal).toLocaleString()}</p>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm divide-y">
                            ${groupedByDate[date].map(ledgerApp.ui.templates.transactionItem).join('')}
                        </div>
                    </div>`;
            }
            dom.transactionsListContainer.innerHTML = listHtml || '<p class="text-center text-gray-500 py-8">No transactions found.</p>';
        },
        renderAnalysis(type = 'expense') {
            const { dom, state, config } = ledgerApp;
            const summaryData = type === 'expense' ? state.summary.categorySpending : state.summary.categoryIncome;
            const totalAmount = type === 'expense' ? state.summary.monthExpense : state.summary.monthIncome;
            
            const sortedData = Object.entries(summaryData)
                .map(([category, amount]) => ({ category, amount }))
                .sort((a,b) => b.amount - a.amount);
            
            // Render breakdown list
            const breakdownHtml = sortedData.map(item => ledgerApp.ui.templates.categoryBreakdownItem(item, totalAmount)).join('');
            dom.categoryBreakdownContainer.innerHTML = breakdownHtml;

            // Update pie chart
            const chartData = sortedData.map(item => {
                const categoryInfo = config.categories[item.category] || config.defaultIcon;
                return {
                    name: categoryInfo.text,
                    value: item.amount,
                    itemStyle: { color: tailwind.config.theme.extend.colors[categoryInfo.color]?.[500] || '#cccccc' }
                };
            });
            state.charts.category.setOption({
                series: [{ data: chartData }],
                legend: { data: chartData.map(d => d.name) }
            });
        },

        // Manages visibility of sections and active states of tabs
        showSection(sectionId) {
            const { dom } = ledgerApp;
            Object.values(dom.sections).forEach(s => s.classList.add('hidden'));
            dom.sections[sectionId].classList.remove('hidden');

            document.querySelectorAll('[data-tab]').forEach(tab => {
                const isProfile = tab.tagName === 'A';
                const isActive = tab.dataset.tab === sectionId;
                tab.classList.toggle('text-primary', isActive);
                tab.classList.toggle('text-gray-500', !isActive);
            });
            
            // Re-render data when a section is shown
            switch (sectionId) {
                case 'dashboard': ledgerApp.ui.renderDashboard(); break;
                case 'transactions': ledgerApp.ui.renderTransactions('all'); break;
                case 'analysis': ledgerApp.ui.renderAnalysis('expense'); break;
                case 'add-transaction': ledgerApp.ui.resetTransactionForm(); break;
            }
        },
        
        resetTransactionForm() {
            ledgerApp.state.dom.transactionForm.reset();
            const today = new Date().toISOString().slice(0, 10);
            ledgerApp.state.dom.dateInput.value = today;
        }
    },

    // Event listeners setup
    events: {
        init() {
            const { dom, ui, events } = ledgerApp;
            // Tab navigation
            document.querySelector('.grid-cols-5').addEventListener('click', (e) => {
                const tab = e.target.closest('[data-tab]');
                if (tab && tab.dataset.tab !== 'profile') {
                    e.preventDefault();
                    ui.showSection(tab.dataset.tab);
                }
            });
            dom.addTransactionBtn.addEventListener('click', () => ui.showSection('add-transaction'));

            // Transaction page filters
            dom.transactionsFilterContainer.addEventListener('click', e => {
                const button = e.target.closest('button');
                if (!button) return;
                
                dom.transactionsFilterContainer.querySelectorAll('button').forEach(btn => {
                    btn.classList.remove('bg-primary', 'text-white');
                    btn.classList.add('bg-gray-100', 'text-gray-600');
                });
                button.classList.add('bg-primary', 'text-white');
                button.classList.remove('bg-gray-100', 'text-gray-600');
                
                ledgerApp.ui.renderTransactions(button.dataset.filter);
            });
            
            // Analysis page toggles
            dom.expenseToggle.addEventListener('click', events.handleAnalysisToggle);
            dom.incomeToggle.addEventListener('click', events.handleAnalysisToggle);
        },
        handleAnalysisToggle(e) {
            const { dom } = ledgerApp;
            const type = e.target.id === 'expense-toggle' ? 'expense' : 'income';
            dom.expenseToggle.classList.toggle('bg-primary', type === 'expense');
            dom.expenseToggle.classList.toggle('text-white', type === 'expense');
            dom.expenseToggle.classList.toggle('bg-gray-100', type !== 'expense');
            dom.expenseToggle.classList.toggle('text-gray-600', type !== 'expense');

            dom.incomeToggle.classList.toggle('bg-primary', type === 'income');
            dom.incomeToggle.classList.toggle('text-white', type === 'income');
            dom.incomeToggle.classList.toggle('bg-gray-100', type !== 'income');
            dom.incomeToggle.classList.toggle('text-gray-600', type !== 'income');
            
            ledgerApp.ui.renderAnalysis(type);
        }
    },

    // Initialization logic
    init() {
        // 1. Cache all necessary DOM elements
        this.state.dom = {
            sections: {
                dashboard: document.getElementById('dashboard'),
                addTransaction: document.getElementById('add-transaction'),
                transactions: document.getElementById('transactions'),
                analysis: document.getElementById('analysis'),
            },
            currentMonthDisplay: document.getElementById('current-month-display'),
            totalBalance: document.getElementById('total-balance'),
            totalIncome: document.getElementById('total-income'),
            totalExpense: document.getElementById('total-expense'),
            recentTransactionsContainer: document.getElementById('recent-transactions-container'),
            topCategoriesContainer: document.getElementById('top-categories-container'),
            transactionsListContainer: document.getElementById('transactions-list-container'),
            transactionsFilterContainer: document.getElementById('transactions-filter-container'),
            categoryBreakdownContainer: document.getElementById('category-breakdown-container'),
            addTransactionBtn: document.getElementById('add-transaction-btn'),
            exchangeRateDisplay: document.getElementById('exchange-rate-display'),
            transactionForm: document.getElementById('transaction-form'),
            dateInput: document.getElementById('date'),
            categorySelect: document.getElementById('category'),
            expenseToggle: document.getElementById('expense-toggle'),
            incomeToggle: document.getElementById('income-toggle'),
        };
        
        // 2. Populate dynamic UI elements
        this.initDynamicContent();

        // 3. Load data
        this.api.loadTransactions();
        this.api.fetchExchangeRate();
        setInterval(this.api.fetchExchangeRate, 3600000); // Update every hour

        // 4. Initialize charts
        this.initCharts();

        // 5. Process initial data
        this.core.calculateSummary();

        // 6. Set up event listeners
        this.events.init();

        // 7. Show the initial section
        this.ui.showSection('dashboard');
        
        console.log("Ledger App Initialized (Optimized Version)");
    },
    
    initDynamicContent() {
        const { dom, config } = this;
        // Populate category dropdown
        let categoryOptions = '<option value="" disabled selected>Select category</option>';
        for(const [value, {text}] of Object.entries(config.categories)) {
            categoryOptions += `<option value="${value}">${text}</option>`;
        }
        dom.categorySelect.innerHTML = categoryOptions;

        // Populate filter buttons
        let filterButtons = '';
        for(const [key, text] of Object.entries(config.filters)) {
            const isDefault = key === 'all';
            const classes = isDefault 
                ? 'bg-primary text-white' 
                : 'bg-gray-100 text-gray-600';
            filterButtons += `<button data-filter="${key}" class="whitespace-nowrap px-3 py-1 ${classes} text-xs rounded-full !rounded-button">${text}</button>`;
        }
        dom.transactionsFilterContainer.innerHTML = filterButtons;
        
        // Set current month display
        const today = this.state.currentDate;
        dom.currentMonthDisplay.textContent = `${today.toLocaleString('en-US', { month: 'long' })} ${today.getFullYear()}`;
    },
    
    initCharts() {
        this.state.charts.spending = echarts.init(document.getElementById('spending-chart'));
        this.state.charts.spending.setOption({
            tooltip: { trigger: 'axis', formatter: p => `₩${p[0].value.toLocaleString()}`},
            grid: { left: '3%', right: '4%', bottom: '3%', top: '3%', containLabel: true },
            xAxis: { type: 'category', data: [], axisLine: { lineStyle: { color: '#EAEAEA' }}, axisLabel: { color: '#999' }},
            yAxis: { type: 'value', axisLine: { show: false }, axisTick: { show: false }, axisLabel: { show: false }, splitLine: { lineStyle: { color: '#EAEAEA' }}},
            series: [{ data: [], type: 'line', smooth: true, symbol: 'circle', symbolSize: 8, itemStyle: { color: '#4F46E5' }, lineStyle: { width: 3 }, areaStyle: { color: { type: 'linear', x: 0, y: 0, x2: 0, y2: 1, colorStops: [{ offset: 0, color: 'rgba(79, 70, 229, 0.3)' }, { offset: 1, color: 'rgba(79, 70, 229, 0.05)' }]}}}]
        });

        this.state.charts.category = echarts.init(document.getElementById('category-chart'));
        this.state.charts.category.setOption({
            tooltip: { trigger: 'item', formatter: p => `${p.name}: ₩${p.value.toLocaleString()} (${p.percent}%)` },
            legend: { orient: 'horizontal', bottom: 0, data: [] },
            series: [{ type: 'pie', radius: ['40%', '70%'], center: ['50%', '45%'], avoidLabelOverlap: false, itemStyle: { borderRadius: 10, borderColor: '#fff', borderWidth: 2 }, label: { show: false }, labelLine: { show: false }, data: []}]
        });

        window.addEventListener('resize', () => {
            this.state.charts.spending.resize();
            this.state.charts.category.resize();
        });
    }
};

// Start the application once the DOM is fully loaded
document.addEventListener('DOMContentLoaded', () => ledgerApp.init());

</script>

</body>
</html>
