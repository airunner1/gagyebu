<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Budget App (Mobile Fixed)</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        primary: '#4F46E5', 
                        secondary: '#10B981',
                        danger: '#EF4444' 
                    },
                    borderRadius: { 'button': '8px' }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F9FAFB; -webkit-font-smoothing: antialiased; }
        .hide-arrows::-webkit-outer-spin-button, .hide-arrows::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .hide-arrows { -moz-appearance: textfield; }
        button:active, [data-tab]:active { transform: scale(0.97); transition: transform 0.05s ease-in-out; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4F46E5; border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="fixed top-0 w-full bg-white shadow-sm z-50">
        <div class="flex items-center justify-between px-4 py-3 max-w-4xl mx-auto">
            <h1 class="text-xl font-bold text-primary">Budget App</h1>
            <button class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100"><i class="ri-settings-3-line ri-lg text-gray-600"></i></button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pt-16 pb-20 min-h-screen">
        <div class="max-w-4xl mx-auto">
            <!-- Dashboard Section -->
            <section id="dashboard-section" class="px-4 py-4">
                <div class="flex items-center justify-between mb-4">
                    <button id="dashboard-prev-month" class="p-2 rounded-full hover:bg-gray-100"><i class="ri-arrow-left-s-line ri-xl"></i></button>
                    <h2 class="text-lg font-semibold" id="dashboard-month-display"></h2>
                    <button id="dashboard-next-month" class="p-2 rounded-full hover:bg-gray-100"><i class="ri-arrow-right-s-line ri-xl"></i></button>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-5 mb-5">
                    <p class="text-sm text-gray-500 mb-2">월별 요약</p>
                    <h2 class="text-3xl font-bold" id="total-balance">₩0</h2>
                    <div class="flex justify-between mt-4 text-sm">
                        <div><p class="text-gray-500">수입</p><p class="font-medium text-green-600" id="total-income">+₩0</p></div>
                        <div class="text-right"><p class="text-gray-500">지출</p><p class="font-medium text-red-600" id="total-expense">-₩0</p></div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-5 mb-5">
                    <h3 class="font-semibold mb-4">카테고리별 지출</h3>
                    <div id="dashboard-category-chart" class="w-full h-56"></div>
                </div>
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-semibold">최근 거래 내역</h3>
                    <button id="see-all-btn" class="text-primary text-sm font-medium">전체 보기</button>
                </div>
                <div id="recent-transactions-container" class="bg-white rounded-xl shadow-sm"></div>
            </section>

            <!-- Transactions Section -->
            <section id="transactions-section" class="hidden px-4 py-4">
                <h2 class="text-xl font-semibold mb-4">전체 거래 내역</h2>
                <div id="transactions-filter-container" class="flex space-x-2 mb-4 overflow-x-auto pb-2"></div>
                <div id="transactions-list-container"></div>
            </section>

            <!-- Add Transaction Section -->
            <section id="add-section" class="hidden px-4 py-4">
                 <h2 id="form-title" class="text-xl font-semibold mb-4">새 거래 추가</h2>
                <form id="transaction-form" class="space-y-4">
                    <div><p class="text-sm font-medium text-gray-700 mb-2">거래 유형</p><div class="flex bg-gray-100 rounded-full p-1"><button type="button" data-type="expense" class="transaction-type-btn flex-1 py-2 rounded-full bg-primary text-white text-sm font-medium">지출</button><button type="button" data-type="income" class="transaction-type-btn flex-1 py-2 rounded-full text-gray-600 text-sm font-medium">수입</button></div></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1" for="amount">금액</label><div class="relative"><div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-500">₩</div><input type="number" id="amount" class="hide-arrows w-full pl-7 pr-3 py-2 bg-gray-100 rounded-lg border-none focus:ring-2 focus:ring-primary" placeholder="0" required></div></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1" for="text">내용</label><input type="text" id="text" class="w-full px-3 py-2 bg-gray-100 rounded-lg border-none focus:ring-2 focus:ring-primary" placeholder="예: 스타벅스 커피" required></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1" for="category">카테고리</label><div class="relative"><select id="category" class="w-full px-3 py-2 bg-gray-100 rounded-lg border-none focus:ring-2 focus:ring-primary appearance-none"></select><div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"><i class="ri-arrow-down-s-line text-gray-500"></i></div></div></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1" for="date">날짜</label><input type="date" id="date" class="w-full px-3 py-2 bg-gray-100 rounded-lg border-none focus:ring-2 focus:ring-primary"></div>
                    <button id="save-btn" type="submit" class="w-full bg-primary text-white py-3 rounded-lg font-semibold !rounded-button mt-6">거래 저장</button>
                    <button id="delete-btn" type="button" class="hidden w-full bg-danger text-white py-3 rounded-lg font-semibold !rounded-button mt-2">삭제하기</button>
                </form>
            </section>
            
            <!-- AI Analysis Section -->
            <section id="ai-section" class="hidden px-4 py-4">
                <h2 class="text-xl font-semibold mb-4">AI 영수증 분석</h2>
                <div class="bg-white p-6 rounded-xl shadow-sm space-y-4">
                    <p class="text-sm text-gray-600">스마트폰 결제 내역이나 영수증 스크린샷을 업로드하면 AI가 자동으로 분석하여 가계부에 추가해줍니다.</p>
                    <div id="ai-image-preview-container" class="hidden w-full p-2 border-2 border-dashed rounded-lg">
                        <img id="ai-image-preview" class="max-h-64 w-auto mx-auto rounded-md" />
                    </div>
                    <label for="ai-file-upload" class="w-full cursor-pointer bg-gray-100 text-gray-800 font-semibold py-3 px-4 rounded-lg !rounded-button inline-flex items-center justify-center hover:bg-gray-200">
                        <i class="ri-image-add-line mr-2"></i>
                        <span id="ai-upload-label">영수증/내역 이미지 선택</span>
                    </label>
                    <input id="ai-file-upload" type="file" class="hidden" accept="image/*">
                    
                    <button id="ai-analyze-btn" class="w-full bg-primary text-white font-semibold py-3 rounded-lg !rounded-button flex items-center justify-center space-x-2 disabled:bg-gray-300" disabled>
                        <i class="ri-magic-line"></i>
                        <span>AI로 분석하기</span>
                    </button>
                    
                    <div id="ai-status-container" class="pt-4"></div>
                </div>
            </section>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 w-full bg-white/80 backdrop-blur-sm shadow-lg border-t border-gray-200 z-50">
        <div class="grid grid-cols-4 h-16 max-w-4xl mx-auto">
            <button data-tab="dashboard" class="flex flex-col items-center justify-center space-y-1 text-primary"><i class="ri-home-4-fill ri-lg"></i><span class="text-xs font-medium">홈</span></button>
            <button data-tab="transactions" class="flex flex-col items-center justify-center space-y-1 text-gray-500"><i class="ri-list-check-2 ri-lg"></i><span class="text-xs font-medium">내역</span></button>
            <button data-tab="add" class="flex flex-col items-center justify-center space-y-1 text-gray-500"><i class="ri-add-circle-line ri-lg"></i><span class="text-xs font-medium">추가</span></button>
            <button data-tab="ai" class="flex flex-col items-center justify-center space-y-1 text-gray-500"><i class="ri-user-scan-line ri-lg"></i><span class="text-xs font-medium">AI 분석</span></button>
        </div>
    </nav>

<script>
const budgetApp = {
    state: {
        transactions: [],
        currentDate: new Date(),
        activeFilter: 'all',
        editingTxId: null,
        charts: { dashboard: null },
        aiImageBase64: null,
    },
    config: {
        localStorageKey: 'budgetAppTransactions_v12',
        categories: {
            expense: [
                { id: 'food', text: '음식', icon: 'restaurant-2', keywords:['음식', '식사', '푸드', '레스토랑', '공덕', '밀국수'] }, 
                { id: 'fashion', text: '패션', icon: 't-shirt', keywords:['패션','의류','쇼핑'] },
                { id: 'date', text: '데이트', icon: 'heart-3', keywords:['데이트'] }, { id: 'points_expense', text: '포인트 사용', icon: 'star-half', keywords:['포인트'] },
                { id: 'transport', text: '교통', icon: 'bus', keywords:['교통', '택시', '버스', '발렛'] }, { id: 'housing', text: '주거/통신', icon: 'home-gear', keywords:['통신','월세'] },
                { id: 'leisure', text: '문화/여가', icon: 'gamepad', keywords:['여가','게임','영화'] }, { id: 'other', text: '기타 지출', icon: 'price-tag-3', keywords:['기타'] }
            ],
            income: [
                { id: 'salary', text: '월급', icon: 'briefcase-4', keywords:['월급', '급여'] }, { id: 'investment', text: '투자', icon: 'line-chart', keywords:['투자','수익'] },
                { id: 'offset', text: '상계', icon: 'swap-line', keywords:['상계'] }, { id: 'points_income', text: '포인트', icon: 'star', keywords:['포인트','적립'] }, 
                { id: 'allowance', text: '용돈', icon: 'gift', keywords:['용돈'] }, { id: 'other_income', text: '기타 수입', icon: 'creative-commons-nd', keywords:['기타'] }
            ]
        },
        filters: [
            { id: 'all', text: '전체' }, { id: 'expense', text: '지출' }, { id: 'income', text: '수입' },
            { id: 'food', text: '음식' }, { id: 'fashion', text: '패션' }, { id: 'date', text: '데이트' }
        ]
    },
    dom: {},

    init() {
        this.cacheDom();
        this.initCharts(); 
        this.events.init();
        this.api.loadTransactions();
        this.ui.populateFilters();
        this.ui.showSection('dashboard');
        console.log("Budget App Initialized (Mobile Fix)");
    },
    
    initCharts() {
        this.state.charts.dashboard = echarts.init(this.dom.dashboardCategoryChart);
        this.state.charts.dashboard.setOption({
            tooltip: { trigger: 'item', formatter: p => `${p.name}:<br/><b>₩${p.value.toLocaleString()}</b> (${p.percent}%)` },
            series: [{ type: 'sunburst', radius: ['30%', '90%'], itemStyle: { borderRadius: 7, borderWidth: 2 }, label: { show: true, formatter: '{b}', fontSize: 12, color: '#333' }, emphasis: { label: { show: true, fontSize: '14', fontWeight: 'bold' } }, data: [] }]
        });
    },

    cacheDom() {
        this.dom = {
            main: document.querySelector('main'),
            sections: { dashboard: document.getElementById('dashboard-section'), transactions: document.getElementById('transactions-section'), add: document.getElementById('add-section'), ai: document.getElementById('ai-section') },
            nav: document.querySelector('nav'),
            dashboardDisplay: document.getElementById('dashboard-month-display'),
            totalBalance: document.getElementById('total-balance'),
            totalIncome: document.getElementById('total-income'),
            totalExpense: document.getElementById('total-expense'),
            recentTransactions: document.getElementById('recent-transactions-container'),
            dashboardCategoryChart: document.getElementById('dashboard-category-chart'),
            filterContainer: document.getElementById('transactions-filter-container'),
            listContainer: document.getElementById('transactions-list-container'),
            form: document.getElementById('transaction-form'),
            formTitle: document.getElementById('form-title'),
            saveBtn: document.getElementById('save-btn'),
            deleteBtn: document.getElementById('delete-btn'),
            typeButtons: document.querySelectorAll('.transaction-type-btn'),
            amountInput: document.getElementById('amount'),
            textInput: document.getElementById('text'),
            categorySelect: document.getElementById('category'),
            dateInput: document.getElementById('date'),
            aiFileUpload: document.getElementById('ai-file-upload'),
            aiUploadLabel: document.getElementById('ai-upload-label'),
            aiImagePreviewContainer: document.getElementById('ai-image-preview-container'),
            aiImagePreview: document.getElementById('ai-image-preview'),
            aiAnalyzeBtn: document.getElementById('ai-analyze-btn'),
            aiStatusContainer: document.getElementById('ai-status-container'),
        };
    },

    core: {
        addTransaction(newTx) { budgetApp.state.transactions.unshift(newTx); this.sortTransactions(); budgetApp.api.saveTransactions(); },
        updateTransaction(updatedTx) { const index = budgetApp.state.transactions.findIndex(t => t.id === updatedTx.id); if (index > -1) { budgetApp.state.transactions[index] = updatedTx; this.sortTransactions(); budgetApp.api.saveTransactions(); } },
        deleteTransaction(txId) { budgetApp.state.transactions = budgetApp.state.transactions.filter(t => t.id !== txId); budgetApp.api.saveTransactions(); },
        sortTransactions() { budgetApp.state.transactions.sort((a,b) => new Date(b.date) - new Date(a.date)); },
        getTransactionsForMonth(date) { const year = date.getFullYear(); const month = date.getMonth(); return budgetApp.state.transactions.filter(t => { const txDate = new Date(t.date); return txDate.getFullYear() === year && txDate.getMonth() === month; }); },
    },

    api: {
        loadTransactions() {
            const stored = localStorage.getItem(budgetApp.config.localStorageKey);
            if (stored) { budgetApp.state.transactions = JSON.parse(stored); } else {
                const today = new Date();
                budgetApp.state.transactions = [
                    { id: `tx${Date.now()+1}`, type: 'expense', amount: 12000, date: today.toISOString().slice(0,10), category: 'food', text: '점심 (파스타)' },
                    { id: `tx${Date.now()+2}`, type: 'expense', amount: 55000, date: new Date(new Date().setDate(today.getDate() - 1)).toISOString().slice(0,10), category: 'fashion', text: 'H&M 티셔츠' },
                    { id: `tx${Date.now()+3}`, type: 'income', amount: 3000000, date: new Date(new Date().setDate(today.getDate() - 2)).toISOString().slice(0,10), category: 'salary', text: `${today.getMonth()+1}월 급여` }
                ];
                budgetApp.core.sortTransactions();
                this.saveTransactions();
            }
        },
        saveTransactions() { localStorage.setItem(budgetApp.config.localStorageKey, JSON.stringify(budgetApp.state.transactions)); },
        async analyzeReceiptImage(base64ImageData) {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const prompt = `You are an expert data extractor. Analyze the provided image of a transaction history. Extract every individual transaction. For each transaction, provide the date, description, and amount. Use the current year, 2025. The date format in the image 'MM. DD.' should be converted to 'YYYY-MM-DD'. The description is the store name or transaction reason. The amount is the number with a '원' suffix. Determine if it's 'income' or 'expense' (all transactions in the image are expenses). Finally, guess a category from the following list based on the description: 음식, 패션, 데이트, 교통, 기타 지출. Return a valid JSON array of objects.`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }, { inline_data: { mime_type: "image/png", data: base64ImageData } }] }], generation_config: { response_mime_type: "application/json", response_schema: { type: "ARRAY", items: { type: "OBJECT", properties: { "date": { "type": "STRING", "description": "YYYY-MM-DD" }, "description": { "type": "STRING" }, "amount": { "type": "NUMBER" }, "category_guess": { "type": "STRING", "description": "Guess from '음식', '패션', '데이트', '교통', '기타 지출'"} }, "required": ["date", "description", "amount", "category_guess"] } } } };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { throw new Error(`API Error: ${response.status} ${response.statusText}`); }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts.length > 0) {
                    return JSON.parse(result.candidates[0].content.parts[0].text);
                } else { throw new Error("AI did not return valid data."); }
            } catch (error) { console.error("Gemini API Call failed:", error); throw error; }
        }
    },

    ui: {
        showSection(sectionId) {
            Object.values(budgetApp.dom.sections).forEach(s => s.classList.add('hidden'));
            budgetApp.dom.sections[sectionId].classList.remove('hidden');
            const activeTab = budgetApp.dom.nav.querySelector(`[data-tab="${sectionId}"]`);
            if (activeTab) { budgetApp.dom.nav.querySelectorAll('[data-tab]').forEach(t => t.classList.replace('text-primary', 'text-gray-500')); activeTab.classList.replace('text-gray-500', 'text-primary'); }
            if (this.render[sectionId]) this.render[sectionId]();
        },
        render: {
            dashboard() {
                const { currentDate, transactions } = budgetApp.state;
                const monthlyTxs = budgetApp.core.getTransactionsForMonth(currentDate);
                let monthIncome = 0, monthExpense = 0;
                monthlyTxs.forEach(t => t.type === 'income' ? monthIncome += t.amount : monthExpense += t.amount);
                
                budgetApp.dom.dashboardDisplay.textContent = `${currentDate.getFullYear()}년 ${currentDate.getMonth() + 1}월`;
                budgetApp.dom.totalBalance.textContent = `₩${(monthIncome - monthExpense).toLocaleString()}`;
                budgetApp.dom.totalIncome.textContent = `+₩${monthIncome.toLocaleString()}`;
                budgetApp.dom.totalExpense.textContent = `-₩${monthExpense.toLocaleString()}`;

                const recentTxs = transactions.slice(0, 5);
                budgetApp.dom.recentTransactions.innerHTML = recentTxs.length > 0 ? `<div class="divide-y divide-gray-100">${recentTxs.map(t => budgetApp.ui.templates.transactionItem(t)).join('')}</div>` : `<div class="text-center p-8 text-gray-500">거래 내역이 없습니다.</div>`;

                const expenseByCategory = {};
                monthlyTxs.filter(t => t.type === 'expense').forEach(t => { const category = budgetApp.config.categories.expense.find(c => c.id === t.category); if (category) { expenseByCategory[category.text] = (expenseByCategory[category.text] || 0) + t.amount; } });
                const chartData = Object.entries(expenseByCategory).map(([name, value]) => ({ name, value }));
                budgetApp.state.charts.dashboard.setOption({ series: [{ data: chartData }] }, { notMerge: true });
            },
            transactions() {
                const { transactions, activeFilter } = budgetApp.state;
                const filteredTxs = transactions.filter(t => { if (activeFilter === 'all') return true; if (activeFilter === 'income' || activeFilter === 'expense') return t.type === activeFilter; return t.category === activeFilter; });
                if (filteredTxs.length === 0) { budgetApp.dom.listContainer.innerHTML = `<div class="text-center py-16 text-gray-500">해당 내역이 없습니다.</div>`; } else {
                    const grouped = filteredTxs.reduce((acc, tx) => { (acc[tx.date] = acc[tx.date] || []).push(tx); return acc; }, {});
                    let html = '';
                    Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a)).forEach(date => { html += `<div class="mb-4"><h3 class="font-semibold text-gray-600 px-1 mb-2">${new Date(date+'T00:00:00').toLocaleDateString('ko-KR', { month: 'long', day: 'numeric', weekday: 'long' })}</h3><div class="bg-white rounded-xl shadow-sm">${grouped[date].map(tx => budgetApp.ui.templates.transactionItem(tx)).join('')}</div></div>`; });
                    budgetApp.dom.listContainer.innerHTML = html;
                }
            },
            add() { budgetApp.state.editingTxId = null; budgetApp.dom.formTitle.textContent = '새 거래 추가'; budgetApp.dom.saveBtn.textContent = '거래 저장'; budgetApp.dom.deleteBtn.classList.add('hidden'); budgetApp.dom.form.reset(); budgetApp.dom.dateInput.value = new Date().toISOString().slice(0, 10); budgetApp.events.setActiveTypeButton('expense'); budgetApp.ui.updateCategoryOptions('expense'); },
            ai() { /* Reset the AI section UI */ }
        },
        populateFilters() { budgetApp.dom.filterContainer.innerHTML = budgetApp.config.filters.map((f, i) => `<button data-filter="${f.id}" class="filter-btn whitespace-nowrap px-4 py-2 text-sm font-medium rounded-full ${i === 0 ? 'bg-primary text-white' : 'bg-gray-200 text-gray-700'}">${f.text}</button>`).join(''); },
        updateCategoryOptions(type) { budgetApp.dom.categorySelect.innerHTML = budgetApp.config.categories[type].map(c => `<option value="${c.id}">${c.text}</option>`).join(''); },
        toggleEditView(wrapper, showEdit) { wrapper.querySelector('.display-view').classList.toggle('hidden', showEdit); wrapper.querySelector('.edit-view').classList.toggle('hidden', !showEdit); },
        templates: {
            transactionItem(t) {
                const allCategories = [...budgetApp.config.categories.expense, ...budgetApp.config.categories.income];
                const category = allCategories.find(c => c.id === t.category) || {};
                const color = t.type === 'income' ? 'text-green-600' : 'text-red-600';
                return `
                <div class="transaction-item-wrapper border-b border-gray-100 last:border-b-0" data-id="${t.id}">
                    <div class="display-view flex items-center p-4">
                        <div class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-xl mr-4"><i class="ri-${category.icon || 'question'}-line ri-lg text-gray-700"></i></div>
                        <div class="flex-1"><p class="font-medium leading-tight">${t.text}</p><p class="text-sm text-gray-500">${new Date(t.date+'T00:00:00').toLocaleDateString('ko-KR', {month:'long', day:'numeric'})}</p></div>
                        <p class="font-bold text-lg ${color} mr-4">${t.type === 'income' ? '+' : '-'}₩${t.amount.toLocaleString()}</p>
                        <button class="edit-btn p-2 rounded-full hover:bg-gray-200"><i class="ri-pencil-line text-gray-500"></i></button>
                    </div>
                </div>`;
            }
        }
    },
    
    events: {
        init() {
            budgetApp.dom.nav.addEventListener('click', e => { const tab = e.target.closest('button[data-tab]'); if (tab && !tab.disabled) budgetApp.ui.showSection(tab.dataset.tab); });
            budgetApp.dom.main.addEventListener('click', this.handleListClick.bind(this));
            document.getElementById('dashboard-prev-month').addEventListener('click', () => this.changeMonth(-1, 'dashboard'));
            document.getElementById('dashboard-next-month').addEventListener('click', () => this.changeMonth(1, 'dashboard'));
            document.getElementById('see-all-btn').addEventListener('click', () => budgetApp.ui.showSection('transactions'));
            budgetApp.dom.form.addEventListener('submit', this.handleFormSubmit.bind(this));
            budgetApp.dom.typeButtons.forEach(btn => btn.addEventListener('click', this.handleTypeChange.bind(this)));
            budgetApp.dom.filterContainer.addEventListener('click', this.handleFilterClick);
            budgetApp.dom.aiFileUpload.addEventListener('change', this.handleAiFileSelect.bind(this));
            budgetApp.dom.aiAnalyzeBtn.addEventListener('click', this.handleAiAnalyzeClick.bind(this));
        },
        changeMonth(direction, view) { budgetApp.state.currentDate.setMonth(budgetApp.state.currentDate.getMonth() + direction, 1); if (budgetApp.ui.render[view]) { budgetApp.ui.render[view](); } },
        handleFormSubmit(e) { e.preventDefault(); const form = budgetApp.dom; const amount = parseInt(form.amountInput.value); if (!amount || amount <= 0 || !form.textInput.value) { alert("금액과 내용을 올바르게 입력해주세요."); return; } const type = document.querySelector('.transaction-type-btn.bg-primary').dataset.type; const newTx = { id: `tx${Date.now()}`, type, amount, date: form.dateInput.value, category: form.categorySelect.value, text: form.textInput.value }; budgetApp.core.addTransaction(newTx); alert("저장되었습니다."); budgetApp.ui.showSection('dashboard'); },
        handleListClick(e) {
            const editBtn = e.target.closest('.edit-btn');
            if (editBtn) {
                alert("수정 기능은 현재 개발 중입니다. '추가' 탭에서 새 내역을 작성해주세요.");
            }
        },
        handleTypeChange(e) { const selectedType = e.target.dataset.type; this.setActiveTypeButton(selectedType, '.transaction-type-btn'); budgetApp.ui.updateCategoryOptions(selectedType); },
        setActiveTypeButton(type, selector) { document.querySelectorAll(selector).forEach(btn => { btn.classList.toggle('bg-primary', btn.dataset.type === type); btn.classList.toggle('text-white', btn.dataset.type === type); btn.classList.toggle('text-gray-600', btn.dataset.type !== type); }); },
        handleFilterClick(e) { const btn = e.target.closest('button.filter-btn'); if(!btn) return; budgetApp.dom.filterContainer.querySelectorAll('.filter-btn').forEach(b => { b.classList.replace('bg-primary', 'bg-gray-200'); b.classList.replace('text-white','text-gray-700'); }); btn.classList.replace('bg-gray-200','bg-primary'); btn.classList.replace('text-gray-700','text-white'); budgetApp.state.activeFilter = btn.dataset.filter; budgetApp.ui.render.transactions(); },

        handleAiFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                budgetApp.state.aiImageBase64 = e.target.result.split(',')[1];
                budgetApp.dom.aiImagePreview.src = e.target.result;
                budgetApp.dom.aiImagePreviewContainer.classList.remove('hidden');
                budgetApp.dom.aiUploadLabel.textContent = file.name;
                budgetApp.dom.aiAnalyzeBtn.disabled = false;
                budgetApp.dom.aiStatusContainer.innerHTML = '';
            };
            reader.readAsDataURL(file);
        },

        async handleAiAnalyzeClick() {
            if (!budgetApp.state.aiImageBase64) { alert("분석할 이미지를 먼저 선택해주세요."); return; }
            const statusContainer = budgetApp.dom.aiStatusContainer;
            statusContainer.innerHTML = `<div class="flex items-center justify-center p-4"><div class="loader"></div><p class="ml-4 text-gray-600">AI가 이미지를 분석 중입니다...</p></div>`;
            budgetApp.dom.aiAnalyzeBtn.disabled = true;

            try {
                const extractedData = await budgetApp.api.analyzeReceiptImage(budgetApp.state.aiImageBase64);
                if (!extractedData || extractedData.length === 0) { statusContainer.innerHTML = `<p class="text-center text-red-500">이미지에서 거래 내역을 찾을 수 없습니다.</p>`; return; }
                this.displayAiResults(extractedData);
            } catch (error) {
                statusContainer.innerHTML = `<p class="text-center text-red-500">분석 중 오류가 발생했습니다: ${error.message}</p>`;
            } finally {
                 budgetApp.dom.aiAnalyzeBtn.disabled = false;
            }
        },

        displayAiResults(data) {
            const statusContainer = budgetApp.dom.aiStatusContainer;
            let resultsHtml = `<h3 class="font-semibold mb-2">분석 결과 (${data.length}개)</h3><div class="space-y-2">`;
            data.forEach((item, index) => {
                const categoryId = this.findCategoryId(item.category_guess, 'expense');
                const category = budgetApp.config.categories.expense.find(c => c.id === categoryId) || {};
                resultsHtml += `
                    <div class="bg-gray-50 p-3 rounded-lg flex items-center" data-index="${index}">
                        <div class="w-8 h-8 flex-shrink-0 flex items-center justify-center bg-gray-200 rounded-lg mr-3"><i class="ri-${category.icon}-line text-gray-700"></i></div>
                        <div class="flex-1 text-sm">
                            <p class="font-medium">${item.description}</p>
                            <p class="text-gray-500">${item.date} / ₩${item.amount.toLocaleString()} / ${category.text}</p>
                        </div>
                    </div>`;
            });
            resultsHtml += `</div><button id="add-ai-results-btn" class="w-full mt-4 bg-secondary text-white font-semibold py-3 rounded-lg !rounded-button">선택한 내역 추가하기</button>`;
            statusContainer.innerHTML = resultsHtml;

            document.getElementById('add-ai-results-btn').addEventListener('click', () => {
                this.addAiResults(data);
            });
        },

        addAiResults(data) {
            let addedCount = 0;
            data.forEach(item => {
                const newTx = {
                    id: `tx${Date.now() + Math.random()}`,
                    type: 'expense',
                    amount: item.amount,
                    date: item.date,
                    text: item.description,
                    category: this.findCategoryId(item.category_guess, 'expense')
                };
                const isDuplicate = budgetApp.state.transactions.some(t => t.date === newTx.date && t.amount === newTx.amount && t.text === newTx.text);
                if (!isDuplicate) { budgetApp.core.addTransaction(newTx); addedCount++; }
            });
            if (addedCount > 0) { alert(`${addedCount}개의 새로운 거래 내역을 추가했습니다.`); budgetApp.ui.showSection('transactions'); } 
            else { alert("추가할 새로운 거래 내역이 없습니다. (중복 내역 제외)"); }
            budgetApp.dom.aiStatusContainer.innerHTML = '';
            budgetApp.dom.aiImagePreviewContainer.classList.add('hidden');
            budgetApp.dom.aiUploadLabel.textContent = '영수증/내역 이미지 선택';
        },

        findCategoryId(categoryText, type) {
            if (!categoryText) return 'other';
            const categories = budgetApp.config.categories[type];
            for (const category of categories) {
                for (const keyword of category.keywords) {
                    if (categoryText.includes(keyword)) { return category.id; }
                }
            }
            const found = categories.find(c => c.text === categoryText);
            return found ? found.id : (type === 'expense' ? 'other' : 'other_income');
        }
    }
};

document.addEventListener('DOMContentLoaded', () => budgetApp.init());
</script>
</body>
</html>
